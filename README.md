Docker 镜像备份与恢复脚本
此 Bash 脚本允许您将所有 Docker 镜像备份到压缩存档文件中，并在以后恢复它们，同时保留镜像标签（仓库和标签信息）。它支持多种压缩方法，并提供带有进度跟踪的用户友好界面，适合开发者和系统管理员在 Linux 环境中管理 Docker 镜像。
功能特点

备份所有 Docker 镜像：将所有 Docker 镜像（排除无标签镜像 <none>）保存到一个单一的存档文件，文件名包含时间戳（如 docker_images_YYYYMMDD_HHMMSS.tar）。
从备份存档恢复镜像：从备份文件恢复镜像，保持原始的仓库和标签信息。
支持多种压缩方式：支持 gzip（快速，中等压缩率）、zstd（推荐，高速高压缩率）和 xz（最高压缩率，速度慢）。若本地未安装压缩工具，脚本会通过 Docker 容器运行。
交互式菜单：提供简单的菜单界面，允许用户选择备份、恢复或退出。
进度条：在备份、压缩和恢复过程中显示实时进度条，包括百分比、文件大小和可视化进度指示。
压缩率估算：通过采样 20MB 数据估算 gzip、zstd 和 xz 的压缩效果，帮助用户选择最佳压缩方式。
错误处理与兼容性：检查 Docker 可用性、文件完整性和压缩/解压操作的成功与否，确保操作可靠。支持在不同 Linux 系统上运行。

要求
运行此脚本需要以下环境：

Bash shell：脚本基于 Bash 编写，需在 Bash 环境中运行。
Docker：必须安装并运行 Docker，且用户需有执行 Docker 命令的权限（可能需要以 root 身份运行或加入 docker 组）。
bc 工具：用于压缩率计算，通常 Linux 系统默认包含。
GNU coreutils：提供 stat 等命令，用于获取文件大小等信息，通常 Linux 系统默认包含。

权限说明：确保您有运行 Docker 命令的权限。您可以通过以下命令将用户添加到 docker 组：
sudo usermod -aG docker $USER

然后重新登录以应用更改。
安装

从 GitHub 仓库下载脚本（建议命名为 docker_image_manager.sh）。
赋予脚本执行权限：chmod +x docker_image_manager.sh


运行脚本：./docker_image_manager.sh



使用方法
脚本通过交互式菜单操作，启动后会显示以下选项：

备份所有 Docker 镜像

选择此选项以备份所有 Docker 镜像。
脚本会：
检查 Docker 是否可用。
列出所有镜像（使用 docker images），排除无标签镜像。
将每个镜像保存为单独的 .tar 文件，文件名经过特殊字符清理。
将所有 .tar 文件打包成一个单一的 .tar 文件。
显示原始备份文件大小并估算压缩率。
提示选择压缩方式：
不压缩（保留为 .tar 文件）
gzip 压缩（快速，中等压缩率）
zstd 压缩（推荐，高速高压缩率）
xz 压缩（最高压缩率，速度慢）


显示压缩进度并生成最终备份文件，保存在脚本所在目录。


备份文件以时间戳命名，例如 docker_images_20250727_204800.tar.gz。


从备份文件恢复 Docker 镜像

选择此选项以从备份文件恢复镜像。
脚本会：
列出脚本目录中可用的备份文件（支持 .tar、.tar.gz、.tar.zst、.tar.xz 格式）。
提示选择一个备份文件。
解压备份文件到临时目录，显示解压进度。
将解压后的 .tar 文件加载回 Docker（使用 docker load）。
显示恢复进度和最终恢复的镜像列表。


恢复完成后，临时文件会被清理。


退出

退出脚本，结束程序。



备份过程

镜像保存：每个 Docker 镜像使用 docker save 保存为 .tar 文件，文件名经过清理以避免特殊字符问题。
打包：所有镜像的 .tar 文件打包成一个单一的 .tar 文件。
压缩：根据用户选择，应用 gzip、zstd 或 xz 压缩，或保持未压缩。
进度显示：在保存、打包和压缩过程中显示进度条，包括百分比和文件大小。
清理：操作完成后删除临时文件。

恢复过程

文件选择：列出脚本目录中的备份文件，供用户选择。
解压：根据文件格式（.tar、.tar.gz、.tar.zst、.tar.xz）解压到临时目录，显示进度。
镜像加载：使用 docker load 将每个 .tar 文件加载回 Docker。
进度显示：在解压和加载过程中显示进度条。
清理：操作完成后删除临时目录。

注意事项

磁盘空间：备份文件可能较大，请确保脚本所在目录有足够磁盘空间。
压缩工具：如果系统中未安装 gzip、zstd 或 xz，脚本会使用 Docker 容器运行这些工具，确保 Docker 服务可用。
临时文件：脚本在备份和恢复过程中创建临时目录（如 docker_backup_tmp 和 docker_restore_tmp），操作完成后会自动清理。
兼容性：脚本主要为 Linux 环境设计，使用 GNU coreutils 的命令（如 stat -c %s）。在非 GNU 系统（如 macOS）上可能需要调整。
超时设置：进度条监控文件操作，若 15 秒内无变化，脚本会停止监控以避免无限等待。
采样大小：压缩率估算使用 20MB 数据采样，提供更准确的压缩效果预测。

示例
以下是脚本运行的示例流程：
备份镜像

运行 ./docker_image_manager.sh。
选择菜单选项 1（备份）。
脚本列出镜像并开始保存，显示进度如：保存镜像 (1/5): nginx:latest


打包完成后，显示原始大小并估算压缩率：原始备份文件大小: 500M
正在估算压缩率 (采样20MB)...
gzip压缩: 60% (约 300MB)
zstd压缩: 55% (约 275MB)
xz压缩: 50% (约 250MB)


选择压缩方式（例如 3：zstd）。
显示压缩进度，最终生成文件如 docker_images_20250727_204800.tar.zst。

恢复镜像

运行 ./docker_image_manager.sh。
选择菜单选项 2（恢复）。
脚本列出备份文件：可用的备份文件:
1. docker_images_20250727_204800.tar.zst


输入 1 选择文件。
脚本解压并加载镜像，显示进度：恢复镜像 (1/5): nginx:latest


完成后显示恢复的镜像列表：已恢复的镜像:
nginx:latest
redis:6.2
...



许可证
本项目采用 MIT 许可证。请根据您的需求选择合适的许可证并在仓库中添加相应的 LICENSE 文件。
贡献
欢迎为项目贡献代码或建议！请通过以下方式参与：

提交拉取请求（Pull Request）以添加新功能或修复问题。
在 GitHub 仓库上开启问题（Issue）报告 bug 或提出改进建议。

联系方式
如有任何问题或反馈，请在 GitHub 仓库上开启问题。我们会尽快回复并提供支持。
资源
以下资源可帮助您了解脚本使用的技术和工具：

Bash 脚本指南
Docker 文档
